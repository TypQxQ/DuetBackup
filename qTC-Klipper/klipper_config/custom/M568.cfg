[gcode_macro G10]
# rename_existing: G10.1
gcode:
  M568 {rawparams}



[gcode_macro M568]
# M568 Pnnn Rnnn Snnn An Nnnn Mnnn
# P= Tool number. If this parameter is not provided, the current tool is used.
# R= Standby temperature(s)
# S= Active temperature(s)
# A = Required heater state: 0 = off, 1 = standby temperature(s), 2 = active temperature(s)
# N = Time in seconds to wait from docking tool to putting the heater in standy
# M = Time in seconds to wait from docking tool to shuting off the heater
gcode:
  {% if params.P is defined %}
    {% set t = params.P|int %}
  {% elif printer["gcode_macro LOCK_INIT"].tool_current|int >= 0 %}
    {% set t = printer["gcode_macro LOCK_INIT"].tool_current|int %}
  {% else %}
    { action_raise_error("M568: No tool selected and no tool defined.") }
  {% endif %}

    # My first 9 tools are the same physical tool so map to same extruder.
  {% if t|int >= 0 and t|int < 9 %}
    {% set t = 0 %}
  {% endif %}

    # R= Standby temperatrure
  {% if params.R is defined %}
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=heater_standby_temp VALUE={params.R}
  {% endif %}

      # S= Active temperature(s)
  {% if params.S is defined %}
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=heater_active_temp VALUE={params.S}
  {% endif %}

      # N = Time in seconds to wait from docking tool to putting the heater in standy
  {% if params.N is defined %}
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=idle_to_standby VALUE={params.N}
  {% endif %}

      # M = Time in seconds to wait from docking tool to shuting off the heater
  {% if params.M is defined %}
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=idle_to_powerdown VALUE={params.M}
  {% endif %}

  M56800001 {rawparams} T{t}


[gcode_macro M56800001]
# M568 Rawparams as in M568 and T
# T= Tool number passed from previous command
gcode:
  {% set t = params.T %}

    # A = Required heater state: 0 = off, 1 = standby temperature(s), 2 = active temperature(s)
  {% if params.A is defined %}
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=heater_state VALUE={params.A}
    # If heater for specified tool is in standby state and a standby temperature is provided set new temperature.
    {% if params.A|int == 0 %}
      SET_HEATER_TEMPERATURE HEATER={printer["gcode_macro T"~t].extruder} TARGET=0
    {% endif %}
    {% if params.A|int == 1 %}
      SET_HEATER_TEMPERATURE HEATER={printer["gcode_macro T"~t].extruder} TARGET={printer["gcode_macro T"~t].heater_standby_temp}
    {% endif %}
    {% if params.A|int == 2 %}
      SET_HEATER_TEMPERATURE HEATER={printer["gcode_macro T"~t].extruder} TARGET={printer["gcode_macro T"~t].heater_active_temp}
    {% endif %}
  {% endif %}

  M56800002 {rawparams}


[gcode_macro M56800002]
# M568 Rawparams as in M568 and T
# T= Tool number passed from previous command
gcode:
  {% set t = params.T %}
  {% set hs = printer["gcode_macro T"~t|string].heater_state|int %}

    # If heater for specified tool is in standby state and a standby temperature is provided set new temperature.
  {% if hs == 1 and params.R is defined %}
    SET_HEATER_TEMPERATURE HEATER={printer["gcode_macro T"~t].extruder} TARGET={params.R}
  {% endif %}

    # If heater for specified tool is in active state and a active temperature is provided set new temperature.
  {% if hs == 2 and params.S is defined %}
    SET_HEATER_TEMPERATURE HEATER={printer["gcode_macro T"~t].extruder} TARGET={params.S}
  {% endif %}
