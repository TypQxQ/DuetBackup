[gcode_macro G10]
# rename_existing: G10.1
gcode:
  M568 {rawparams}



[gcode_macro M568]
# M568 Pnnn Rnnn Snnn An Nnnn Mnnn
# P= Tool number. If this parameter is not provided, the current tool is used.
# R= Standby temperature(s)
# S= Active temperature(s)
# A = Required heater state: 0 = off, 1 = standby temperature(s), 2 = active temperature(s)
# N = Time in seconds to wait from docking tool to putting the heater in standy
# M = Time in seconds to wait from docking tool to shuting off the heater
gcode:
  {% if params.P is defined %}
    {% set t = params.P|int %}
  {% elif printer["gcode_macro LOCK_INIT"].tool_current|int >= 0 %}
    {% set t = printer["gcode_macro LOCK_INIT"].tool_current|int %}
  {% else %}
    { action_raise_error("M568: No tool selected and no tool defined.") }
  {% endif %}

    # My first 9 tools are the same physical tool so map to same extruder.
  {% if t|int >= 0 and t|int < 9 %}
    {% set t = 0 %}
  {% endif %}

    # R= Standby temperatrure
  {% if params.R is defined %}
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=heater_standby_temp VALUE={params.R}
  {% endif %}

      # S= Active temperature(s)
  {% if params.S is defined %}
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=heater_active_temp VALUE={params.S}
  {% endif %}

      # N = Time in seconds to wait from docking tool to putting the heater in standy
  {% if params.N is defined %}
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=idle_to_standby VALUE={params.N}
  {% endif %}

      # M = Time in seconds to wait from docking tool to shuting off the heater
  {% if params.M is defined %}
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=idle_to_powerdown VALUE={params.M}
  {% endif %}

  M56800001 {rawparams} T{t}


[gcode_macro M56800001]
# M568 Rawparams as in M568 and T
# T= Tool number passed from previous command
gcode:
  {% set t = params.T %}
  {% set te = printer["gcode_macro T"~t].extruder %}
  {% set hs = printer["gcode_macro T"~t|string].heater_state|int %}

    # A = Required heater state: 0 = off, 1 = standby temperature(s), 2 = active temperature(s)
  {% if params.A is defined %}                                                                         # If mode is changed
    SET_GCODE_VARIABLE MACRO=T{t} VARIABLE=heater_state VALUE={params.A}                                 # Save the new mode

    {% if params.A|int == 0 %}                                                                           # If Off mode
      SET_HEATER_TEMPERATURE HEATER={te} TARGET=0                                                          # Set temperature to 0
      M56800003 T{t} N0 M0                                                                                 # Disable standy temperature and standby to shutdown timer.

    {% elif params.A|int == 2 %}                                                                         # If Active mode
      SET_HEATER_TEMPERATURE HEATER={te} TARGET={printer["gcode_macro T"~t].heater_active_temp}            # Set temperature to active temperature.
      M56800003 T{t} N0 M0                                                                                 # Disable standy timers.

    {% elif params.A|int == 1 %}                                                                         # If Standby mode
      {% if printer["gcode_macro T"~t].heater_standby_temp|int > printer[te].temperature|int %}  # If standby temperature is higher than the current temperature
        SET_HEATER_TEMPERATURE HEATER={te} TARGET={printer["gcode_macro T"~t].heater_standby_temp}           # Set the standby temperature instantly
        M56800003 T{t} N0 M{printer["gcode_macro T"~t].idle_to_powerdown}                                    # Disable standy temperature timer and start standby to shutdown timer.
      {% else %}                                                                                           # Else (Standby temperature is lower than the current temperature)
        M56800003 T{t} N{printer["gcode_macro T"~t].idle_to_standby} M{printer["gcode_macro T"~t].idle_to_powerdown}  # Start the standby and shutdown temperature timers.
      {% endif %}                                                                                          # Endif Standby temperature
    {% endif %}                                                                                          # Endif Type of mode
  {% else %}                                                                                           # Else (If no param.A is provided)
    {% if hs == 1 and params.R is defined %}                                                             # If tool is in standby mode and standby temperature is defined
      M56800003 T{t} N{printer["gcode_macro T"~t].idle_to_standby} M{printer["gcode_macro T"~t].idle_to_powerdown}  # Start the standby and shutdown temperature timers.
      SET_HEATER_TEMPERATURE HEATER={te} TARGET={params.R}                                                 # Set the standby temperature instantly
    {% elif hs == 2 and params.S is defined %}                                                           # ElseIf tool is in active mode and active temperature is defined
      M56800003 T{t} N0 M0                                                                                 # Disable standy timers.
      SET_HEATER_TEMPERATURE HEATER={te} TARGET={params.S}                                                 # Set temperature to active temperature.
    {% endif %}                                                                                          # Endif new temperature for current mode
  {% endif %}                                                                                          # Endif param.A is defined


[gcode_macro M56800003]
# M568 Only for setting the delayed gcode standby timers.
# T= Tool number passed from previous command
# N = Time in seconds to wait from docking tool to putting the heater in standy
# M = Time in seconds to wait from docking tool to shuting off the heater
gcode:
  UPDATE_DELAYED_GCODE ID=T{params.T}_standby DURATION={params.N}
  UPDATE_DELAYED_GCODE ID=T{params.T}_powerdown DURATION={params.M}
