# Set fan speed. S= fan speed 0-1 or 2-255 (defult 1, full speed), T= (optional) set fan speed for a tool other than the currently selected one. 
[gcode_macro M106]
#rename_existing: M106.1
variable_fan_speed: 0
gcode:
  {% set S = params.S|default(1)|float %}

  # If value is >1 asume it is given in 0-255 and convert to percentage.
  {% if S > 1 %}
    {% set S=S/255.0 %}
  {% endif %}

  {% if params.T is not defined %}
    {% set tool_current = printer["gcode_macro LOCK_INIT"].tool_current|int %}
    {% if tool_current <0 %}
      {action_respond_info("M106: No mounted tool")}
    {% elif printer["gcode_macro T"~tool_current].fan =="none" %}
      {action_respond_info("M106: Mounted tool has no fan")}
    {% else %}
      SET_GCODE_VARIABLE MACRO=LOCK_INIT VARIABLE=saved_fan_speed VALUE={S}
      SET_FAN_SPEED FAN={printer["gcode_macro T"~tool_current].fan} SPEED={S}
      M117 Fan speed for current tool, T{tool_current}, set to {S}
    {% endif %}
  {% else %} # If T is specified
    {% if printer["gcode_macro T"~params.T].fan =="none" %}
      {action_respond_info("M106: T"~params.T~" tool has no fan")}
    {% else %}
      SET_GCODE_VARIABLE MACRO=LOCK_INIT VARIABLE=saved_fan_speed VALUE={S}
      SET_FAN_SPEED FAN={printer["gcode_macro T"~params.T].fan} SPEED={S}
      M117 Fan speed for T{params.T} set to {S} to fan "{printer["gcode_macro T"~params.T].fan}"
    {% endif %}
  {% endif %}

[gcode_macro M107]
#rename_existing: M107.1
gcode:       
  {% if params.T is not defined %}
    {% set tool_current = printer["gcode_macro LOCK_INIT"].tool_current|int %}
    {% if tool_current <0 %}
      {action_respond_info("M106: No mounted tool")}
#    {% elif printer["gcode_macro T"~tool_current].fan is not defined %} # Does not work
    {% elif printer["gcode_macro T"~tool_current].fan =="none" %}
      {action_respond_info("M106: Mounted tool has no fan")}
    {% else %}
      SET_GCODE_VARIABLE MACRO=LOCK_INIT VARIABLE=saved_fan_speed VALUE=0
      SET_FAN_SPEED FAN={printer["gcode_macro T"~tool_current].fan} SPEED=0
      M117 Fan speed for current tool, T{tool_current}, set to 0
    {% endif %}
  {% else %} # If T is specified
    {% if printer["gcode_macro T"~params.T].fan =="none" %}
#    {% if printer["gcode_macro T"~params.T].fan is not defined %} # Does not work
      {action_respond_info("M106: Mounted tool has no fan")}
    {% else %}
      SET_FAN_SPEED FAN={printer["gcode_macro T"~params.T].fan} SPEED=0
      M117 Fan speed for T{params.T} set to 0
    {% endif %}
  {% endif %}

