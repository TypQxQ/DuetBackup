[gcode_macro M106]
variable_fan_speed: 0
description: Snnn Pnnn
  Set fan speed.
  S: Fan speed 0-1 or 2-255 (optional, defult 1, full speed)
  P: Tool (optional, defaults to the currently selected tool)
  The P parameter specifies tool instead of fan number as in RRF.
gcode:
  RESPOND MSG="M106: Change fan speed: {rawparams}"
  {% set fanspeed = params.S|default(1)|float %}

  # If value is >1 asume it is given in 0-255 and convert to percentage.
  {% if fanspeed > 1 %}
    {% set fanspeed=fanspeed/255.0 %}
  {% endif %}

  {% if params.P is not defined %}
    {% set tool_id = printer["gcode_macro LOCK_INIT"].tool_current %}
  {% else %} # If T is specified
    {% set tool_id = params.P %}
  {% endif %}
  
  {% if tool_id|int >= 0 %}
    {% set tool_id = printer["gcode_macro T"~tool_id].ercf_physical_tool|default(tool_id) %}
    {% set tool = printer["gcode_macro T"~tool_id] %}                                       # Set Physical Tool Object

    {% if tool.fan =="none" %}
      RESPOND MSG="M106: Tool {tool_id} has no fan"
    {% else %}
#      RESPOND MSG="M106: Change fan speed for fan: {tool.fan}"
      SET_GCODE_VARIABLE MACRO=LOCK_INIT VARIABLE=saved_fan_speed VALUE={fanspeed}
      SET_FAN_SPEED FAN={tool.fan} SPEED={fanspeed}
    {% endif %}
  {% else %}
      RESPOND MSG="M106: Tool {tool_id} is invalid."
  {% endif %}

[gcode_macro M107]
description: Pnnn
  Turn off fan.
  P = Tool (optional and defaults to the currently selected tool)
gcode:       
  RESPOND MSG="M107: Turn off Fan: {rawparams}"
  {% if params.P is defined %}
    {% set p = " P"~params.P %}
  {% endif %}
  M106 {p|default("")} S0
