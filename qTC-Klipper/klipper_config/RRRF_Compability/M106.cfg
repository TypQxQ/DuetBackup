# Not yet compatible with virtual tools.

# Set fan speed. This uses a T parameter for tool instead of the P for fan number in RRF.
# S= fan speed 0-1 or 2-255 (defult 1, full speed)
# T= Tool (optional and defaults to the currently selected tool)
[gcode_macro M106]
variable_fan_speed: 0
description: Snnn Tnnn
  Set fan speed. This uses a T parameter for tool instead of the P for fan number in RRF.
  S= fan speed 0-1 or 2-255 (optional, defult 1, full speed)
  T= Tool (optional, defaults to the currently selected tool)
gcode:
  { action_respond_info("M106: Change fan speed: "~rawparams) }

  {% set s = params.S|default(1)|float %}

  # If value is >1 asume it is given in 0-255 and convert to percentage.
  {% if s > 1 %}
    {% set s=s/255.0 %}
  {% endif %}

  {% if params.T is not defined %}
    {% set tool = printer["gcode_macro T"~printer["gcode_macro T"~printer["gcode_macro LOCK_INIT"].tool_current].ercf_physical_tool]|default(printer["gcode_macro T"~printer["gcode_macro LOCK_INIT"].tool_current]) %}
    {% set tool_current = printer["gcode_macro LOCK_INIT"].tool_current|int %}
    {% if tool_current <0 %}
      {action_respond_info("M106: No mounted tool")}
    {% elif printer["gcode_macro T"~tool_current].fan =="none" %}
      {action_respond_info("M106: Mounted tool has no fan")}
    {% else %}
      SET_GCODE_VARIABLE MACRO=LOCK_INIT VARIABLE=saved_fan_speed VALUE={s}
      SET_FAN_SPEED FAN={printer["gcode_macro T"~tool_current].fan} SPEED={s}
    {% endif %}
  {% else %} # If T is specified
    {% if printer["gcode_macro T"~params.T].fan =="none" %}
      {action_respond_info("M106: T"~params.T~" tool has no fan")}
    {% else %}
      SET_GCODE_VARIABLE MACRO=LOCK_INIT VARIABLE=saved_fan_speed VALUE={s}
      SET_FAN_SPEED FAN={printer["gcode_macro T"~params.T].fan} SPEED={s}
    {% endif %}
  {% endif %}

# Turn off fan.
# T= Tool (optional and defaults to the currently selected tool)
[gcode_macro M107]
gcode:       
  { action_respond_info("M107: Turn off Fan: "~rawparams) }
  {% set t = "" %}
  {% if params.T is defined %}
    {% set t = " T"~params.T %}
  {% endif %}
  M106 {t} S0

