[gcode_macro M116]
description: Pnnn Hnnn Snnn
  Waits for all temperatures, or a specified tool or heater's temperature.
  This command can be used without any additional parameters.
  Without parameters it waits for bed and current extruder.
  Only one of either P or H may be used.

  Pnnn Tool number.
  Hnnn Heater number. 0="heater_bed", 1="extruder", 2="extruder1", etc.
  Snnn Tolerance in degC. Defaults to 1*C. Wait will wait until heater is between set temperature +/- tolerance.

gcode:
  RESPOND MSG="M116: Waiting for tool heatup: {rawparams}."

  {% set tolerance = params.S|default(1)|int %}                               # Tolerance from parameters, default 1, as integer.

  # If both P and H is passed, throw a error.
  {% if params.P is defined and params.H is defined  %}
    { action_raise_error("M116: Can't use both P and H parameter.") }

  # If Tool is passed, get the heatername from the tool.
  {% elif params.P is defined  %}
    {% set tool_number = params.P %}                                          # Tool Number from parameters.
  
    # If the tool has a physical parent, then set tool_number to that. As interger.
    {% set tool_number = printer["gcode_macro T"~tool_number].ercf_physical_tool|default(tool_number)|int %}

    # Set heater_name to the extruder name of the physical tool.
    {% set heater_name = printer["gcode_macro T"~tool_number|string].extruder %}

  # Else If Heater is passed, then set heater_name to that.
  {% elif params.H is defined  %}
    {% set heater_number = params.H|int %}                    # Set heater_number to parameter H, as integer .

    # If 0, then heater_bed.
    {% if heater_number == 0  %}
      {% set heater_name = "heater_bed" %}                    # Set heater_name to "heater_bed".

    # Else asume heater is for extruder.
    {% else %}
      # If h is 1 then use for first extruder.
      {% if heater_number == 1  %}
        {% set heater_name = "extruder" %}                    # Set heater_name to first extruder which has no number.

      # When Extruder is not first extruder.
      {% else %}
        {% set heater_name = "extruder"~(heater_number-1) %}  # Because bed is heater_number 0 extruders will be numbered one less.
      {% endif %}
    {% endif %} # /Heater parameter is passed

  # Wait for both bed and current extruder if no parameters passed.
  {% else %}
    SUB_M116_001 HEATER={"heater_bed"} TOLERANCE={tolerance}  # Wait for "heater_bed" with tolerance.
    {% set heater_name = printer.toolhead.extruder %}                 # Set heater_name to active heater.
  {% endif %}

  SUB_M116_001 HEATER={heater_name} TOLERANCE={tolerance}     # Wait for heater_name with tolerance.

  RESPOND MSG="M116: Wait for tool heatup complete."

[gcode_macro SUB_M116_001]
description: Internal subroutine. Do not use!
gcode:
#  RESPOND MSG="SUB_M116_001: Waiting for tool heatup: {rawparams}."

  {% set heater_name = params.HEATER %}
  {% set tolerance = params.TOLERANCE|int %}
  {% set target_temp = printer[heater_name].target|int %}

  # Only wait if set temperature is over 40*C
  {% if target_temp > 40 %}
    TEMPERATURE_WAIT SENSOR={heater_name} MINIMUM={target_temp-tolerance} MAXIMUM={target_temp+tolerance}
  {% endif %}
